name: 'Tiny Flags Action'
description: 'Automatically update feature flags in your repository'
branding:
  icon: 'flag'  # Using the 'flag' icon from Feather icons
  color: 'blue' # GitHub supports: yellow, blue, green, orange, red, purple, or gray
inputs:
  branch:
    description: 'Branch to store feature flags'
    default: 'generated_flag_branch'
    required: false
  token:
    description: 'GitHub token for flag repo access'
    required: true

runs:
  using: 'composite'
  steps:
    - uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Syncing Feature Flags
      shell: bash
      run: |
          python3 ${{ github.action_path }}/flag-parser.py --input_dir . --output_dir ./generated_feature_flags --pattern '**/*FeatureFlag.swift'

    - name: Creating Viewing Page
      shell: bash
      run: |
          python3 ${{ github.action_path }}/html-parser.py --input ${{ github.action_path }}/index-template.html --output ./generated_feature_flags --flags flags.json --repo ${{ github.repository }} --branch ${{ inputs.branch }}

    - name: Pushing Changes to branch
      shell: bash
      run: |
          # setup ID
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          # Check if the branch already exists
          if git show-ref --verify --quiet refs/heads/${{ inputs.branch }}; then
            git checkout ${{ inputs.branch }}
          else
            git checkout -b ${{ inputs.branch }}
          fi
    
          # Add all changes
          git add ./generated_feature_flags && git commit -m "Update Feature Flags"

          # Push changes to new branch
          git push --force https://x-access-token:${{ inputs.token }}@github.com/${{ github.repository }} HEAD

    - name: Deploy to GitHub Pages
      shell: bash
      run: |
          # Fetch and checkout the branch with generated files
          git fetch origin ${{ inputs.branch }}
          git checkout ${{ inputs.branch }}

          # Copy the generated index.html to a temporary location
          cp ./generated_feature_flags/index.html /tmp/index.html

          # Ensure the gh-pages branch exists
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi

          # Remove all files except .git to ensure only index.html is present
          find . -mindepth 1 ! -regex '^./\.git\(/.*\)?' -delete

          # Move the index.html back to the root of the gh-pages branch
          mv /tmp/index.html ./index.html

          # Add and commit the changes
          git add index.html
          git commit -m "Deploy feature flags view to GitHub Pages" || echo "No changes to commit"

          # Push to the gh-pages branch
          git push --force https://x-access-token:${{ inputs.token }}@github.com/${{ github.repository }} gh-pages
    
    - name: Print Link to Page
      shell: bash
      run: |
          echo "::notice::Feature flags view is available at https://${{ github.repository_owner }}.github.io/${{ github.repository }}/"

    # - name: Commit and Push Changes
    #   shell: bash
    #   run: |
    #     git config user.name "GitHub Action"
    #     git config user.email "action@github.com"
    #     git add feature_flags
    #     git diff --quiet && git diff --staged --quiet || (
    #       git commit -m "Update flags" && 
    #       git push && 
    #       echo "::notice::Access feature flags at https://raw.githubusercontent.com/${{ inputs.flags_repo }}/main/feature_flags/{enum}FeatureFlag/{featureName}"
    #     )